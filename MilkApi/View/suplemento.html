<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Suplementos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" />
</head>
<body>
    <nav>
        <div class="nav1">
          <div class="logo">Cownt</div>
          <div class="menu">
            <a href="dashboard.html"><i class="ph-bold ph-house-line"></i> Dashboard</a>
            <a href="estatisticas.html"><i class="ph-bold ph-chart-line"></i> Estatísticas</a>
            <a href="addgado.html" ><i class="ph ph-cow"></i> Gerenciar Gados</a>
            <a href="registro.html"><i class="ph ph-cow"></i> Registros</a>
            <a href="ocorrenciadiaria.html"><i class="ph-bold ph-calendar-dots"></i> Ocorrências Diárias</a>
            <div class="user-menu">
              <div class="user-avatar" onclick="toggleDropdown()"><i class="ph ph-user-circle"></i></div>
              <div class="dropdown" id="dropdownMenu">
                <a class="drop-menu" href="perfil.html"><i class="ph-bold ph-user"></i> Editar Perfil</a>
                <a class="drop-menu" href="#" onclick="logout()"><i class="ph-bold ph-sign-out"></i> Sair da Conta</a>
              </div>
            </div>
          </div>
        </div>
      </nav>

    <div class="body-margin">
        <div class="card-container">
            <h1>Gestão de Suplementos</h1>
            <div class="btn-add" onclick="abrirModal('suplemento')">
                <i class="fa-solid fa-plus"></i> Novo Suplemento
            </div>
        </div>

        <div class="listaCards" id="listaSuplementos"></div>

        <div id="modal" class="modal">
            <div class="modal-content form-modal">
                <span class="close" onclick="fecharModal()">&times;</span>
                <h2 id="modal-titulo"></h2>
                <p class="subtitle">Preencha as informações do suplemento para registrar.</p>

                <form id="modal-form">
                    <input type="hidden" id="suplementoId">

                    <label for="brinco">Brinco do Gado</label>
                    <input type="number" id="brinco" placeholder="Ex: 123" required>

                    <div id="campos-especificos"></div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancelar" onclick="fecharModal()">Cancelar</button>
                        <button type="submit" class="btn-adicionar">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
const apiBase = "https://localhost:7092";
let tipoAtual = "";

function abrirModal(tipo, dados = null) {
    tipoAtual = tipo;
    document.getElementById("modal").style.display = "block";
    document.getElementById("modal-titulo").innerText = dados ? "Editar Suplemento" : "Novo Suplemento";

    document.getElementById("suplementoId").value = dados ? dados.id : "";
    document.getElementById("brinco").value = dados && dados.gado ? dados.gado.brinco : '';

    const hoje = new Date().toISOString().split("T")[0];
    document.getElementById("campos-especificos").innerHTML = `
        <label>Data:</label>
        <input type="date" id="data" value="${dados ? dados.date.split("T")[0] : hoje}" required>
        <label>Tipo:</label>
        <input type="text" id="tipo" value="${dados ? dados.tipo : ''}" required placeholder="Ex.: Mineral, Proteico...">
        <label>Nome:</label>
        <input type="text" id="nome" value="${dados ? dados.nome : ''}" required placeholder="Nome do suplemento">
        <label>Intervalo (dias):</label>
        <input type="number" id="intervalo" value="${dados ? dados.intervalo : ''}" required>
    `;
}

function fecharModal() {
    document.getElementById("modal").style.display = "none";
    document.getElementById("modal-form").reset();
    document.getElementById("campos-especificos").innerHTML = "";
}

async function carregarSuplementos() {
    const usuarioId = localStorage.getItem("userId");
    if (!usuarioId) return;

    const lista = document.getElementById("listaSuplementos");
    lista.innerHTML = "<p>Carregando...</p>";

    try {
        const resp = await fetch(`${apiBase}/suplemento/por-usuario?usuarioId=${usuarioId}`);
        if (!resp.ok) throw new Error("Erro ao buscar suplementos");
        const dados = await resp.json();

        lista.innerHTML = "";
        if (dados.length === 0) {
            lista.innerHTML = "<p>Nenhum registro encontrado.</p>";
            return;
        }

        for (const s of dados) {
            let gado = {};
            try {
                const resGado = await fetch(`${apiBase}/gado/${s.iD_Gado}`);
                if (resGado.ok) gado = await resGado.json();
            } catch {}

            const div = document.createElement("div");
            div.className = "card";

            div.innerHTML = `
                <p class="brinco"><strong>Brinco:</strong> ${gado.brinco || 'N/A'}</p>
                <p><strong>Data:</strong> ${new Date(s.date).toLocaleDateString("pt-BR")}</p>
                <p><strong>Tipo:</strong> ${s.tipo}</p>
                <p><strong>Nome:</strong> ${s.nome}</p>
                <p><strong>Intervalo:</strong> ${s.intervalo} dias</p>
                <div class="card-actions">
                    <button class="btn-edit" onclick='abrirModal("suplemento", ${JSON.stringify({ ...s, gado })})'>
                        <i class="fa-solid fa-pen-to-square"></i> Editar
                    </button>
                    <button class="btn-delete" onclick="excluirSuplemento(${s.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash2-icon lucide-trash-2"><path d="M10 11v6"/><path d="M14 11v6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                </div>
            `;
            lista.appendChild(div);
        }

    } catch (err) {
        lista.innerHTML = "<p>Erro ao carregar registros.</p>";
        console.error(err);
    }
}

async function excluirSuplemento(id) {
    if (!confirm("Deseja excluir este suplemento?")) return;
    try {
        const res = await fetch(`${apiBase}/suplemento/${id}`, { method: "DELETE" });
        if (res.ok) {
            alert("Suplemento excluído com sucesso!");
            carregarSuplementos();
        } else {
            alert("Erro ao excluir suplemento.");
        }
    } catch (err) {
        alert("Erro de conexão: " + err.message);
    }
}

document.getElementById("modal-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const brinco = document.getElementById("brinco").value;
    const usuarioId = localStorage.getItem("userId");

    try {
        const resGado = await fetch(`${apiBase}/gado/por-brinco?brinco=${brinco}&usuarioId=${usuarioId}`);
        if (!resGado.ok) { alert("Gado não encontrado"); return; }
        const gado = await resGado.json();

        const payload = {
            ID_Gado: gado.id,
            Tipo: document.getElementById("tipo").value,
            Nome: document.getElementById("nome").value,
            Date: document.getElementById("data").value,
            intervalo: parseInt(document.getElementById("intervalo").value),
            ID_Usuario: usuarioId
        };

        const suplementoId = document.getElementById("suplementoId").value;
        const url = suplementoId ? `${apiBase}/suplemento/${suplementoId}` : `${apiBase}/suplemento`;
        const method = suplementoId ? "PUT" : "POST";

        const saveRes = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (saveRes.ok) {
            alert("Registro salvo com sucesso!");
            fecharModal();
            carregarSuplementos();
        } else {
            const err = await saveRes.text();
            alert("Erro ao salvar: " + err);
        }

    } catch (err) {
        alert("Erro de conexão: " + err.message);
        console.error(err);
    }
});

carregarSuplementos();
</script>
<script src="app.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Login e Cadastro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 350px;
        }

        h2 {
            text-align: center;
            color: #333;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

            button:hover {
                background-color: #2980b9;
            }

        .toggle {
            text-align: center;
            margin-top: 15px;
            color: #3498db;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="formTitle">Login</h2>

        <div id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginSenha" placeholder="Senha" required>
            <button onclick="login()">Entrar</button>
        </div>

        <div id="cadastroForm" style="display:none;">
            <input type="text" id="cadNome" placeholder="Nome" required>
            <input type="email" id="cadEmail" placeholder="Email" required>
            <input type="password" id="cadSenha" placeholder="Senha" required>
            <input type="password" id="cadConfSenha" placeholder="Confirme sua senha" required>
            <input type="date" id="cadDataNasc" required>
            <input type="text" id="cadCPF" placeholder="CPF" required>
            <button onclick="cadastrar()">Cadastrar</button>
        </div>

        <div class="toggle" onclick="toggleForm()">Não tem conta? Cadastre-se</div>
    </div>

    <script>
const apiUrl = "https://localhost:7092/Usuario"; // altere para o endereço real da API

function toggleForm(){
    const loginForm = document.getElementById("loginForm");
    const cadastroForm = document.getElementById("cadastroForm");
    const title = document.getElementById("formTitle");
    const toggleText = document.querySelector(".toggle");

    if(loginForm.style.display === "none"){
        loginForm.style.display = "block";
        cadastroForm.style.display = "none";
        title.textContent = "Login";
        toggleText.textContent = "Não tem conta? Cadastre-se";
    } else {
        loginForm.style.display = "none";
        cadastroForm.style.display = "block";
        title.textContent = "Cadastro";
        toggleText.textContent = "Já tem conta? Faça login";
    }
}

async function login(){
    const email = document.getElementById("loginEmail").value;
    const senha = document.getElementById("loginSenha").value;

    try {
        const res = await fetch(apiUrl);
        const usuarios = await res.json();

        const user = usuarios.find(u => u.email === email && u.senha === senha);
        if(user){
            alert("Login bem-sucedido! Bem-vindo, " + user.nome);
            
            //localStorage.setItem('userId', Usuario.id);
            localStorage.setItem('userId', user.id);


            localStorage.setItem('authenticated', 'true');
            window.location.href = 'dashboard.html';
        } else {
            alert("Email ou senha incorretos.");
        }
    } catch (err) {
        alert("Erro ao conectar com a API.");
        console.error(err);
    }
        }

        document.getElementById('cadCPF').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não for número
            value = value.replace(/(\d{3})(\d)/, '$1.$2'); // Coloca o primeiro ponto
            value = value.replace(/(\d{3})(\d)/, '$1.$2'); // Coloca o segundo ponto
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); // Coloca o hífen
            e.target.value = value;
        });



        async function cadastrar() {
            const nome = document.getElementById("cadNome").value;
            const email = document.getElementById("cadEmail").value;
            const senha = document.getElementById("cadSenha").value;
            const confSenha = document.getElementById("cadConfSenha").value; // Novo campo
            const data_Nasc = document.getElementById("cadDataNasc").value;
            const cpf = document.getElementById("cadCPF").value;

            // Validação de confirmação de senha
            if (senha !== confSenha) {
                alert("As senhas não coincidem.");
                return; // Para aqui, não segue para cadastro
            }

            try {
                // Buscar usuários existentes para verificar se o e-mail já está cadastrado
                const resGet = await fetch(apiUrl);
                const usuarios = await resGet.json();

                const emailExistente = usuarios.some(u => u.email.toLowerCase() === email.toLowerCase());
                if (emailExistente) {
                    alert("Este e-mail já está cadastrado. Tente fazer login ou use outro e-mail.");
                    return; // Para aqui e não envia o POST
                }

                // Criar o novo usuário
                const usuario = { nome, email, senha, data_Nasc, cpf };

                const resPost = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(usuario)
                });

                if (resPost.ok) {
                    alert("Usuário cadastrado com sucesso!");

                    toggleForm();
                } else {
                    alert("Erro ao cadastrar usuário.");
                }

            } catch (err) {
                alert("Erro ao conectar com a API.");
                console.error(err);
            }
        }

        
</script>

<script src="app.js"></script>

</body>
</html>

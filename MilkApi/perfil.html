<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Editar Perfil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" />
</head>

<body>

  <nav>
    <div class="nav1">
      <div class="logo">Cownt</div>
      <div class="menu">
        <a href="dashboard.html"><i class="ph-bold ph-house-line"></i> Dashboard</a>
        <a href="estatisticas.html"><i class="ph-bold ph-chart-line"></i> Estatísticas</a>
        <a href="addgado.html" ><i class="ph ph-cow"></i> Gerenciar Gados</a>
        <a href="registro.html"><i class="ph ph-cow"></i> Registros</a>
        <a href="ocorrenciadiaria.html"><i class="ph-bold ph-calendar-dots"></i> Ocorrências Diárias</a>
        <div class="user-menu ">
          <div class="user-avatar" onclick="toggleDropdown()"><i class="ph ph-user-circle active"></i></div>
          <div class="dropdown" id="dropdownMenu">
            <a class="drop-menu" href="perfil.html"><i class="ph-bold ph-user"></i> Editar Perfil</a>
            <a class="drop-menu" href="#" onclick="logout()"><i class="ph-bold ph-sign-out"></i> Sair da Conta</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

    <div class="perfil-wrapper">
        <h2>Editar Perfil</h2>
        <p class="perfil-subtitle">Gerencie suas informações pessoais</p>

        <form id="perfilForm">
            <label class="perfil-label">Nome Completo</label>
            <input type="text" id="nome" class="perfil-input" required>

            <label class="perfil-label">CPF</label>
            <input type="text" id="cpf" class="perfil-input" required>

            <label class="perfil-label">Data de Nascimento</label>
            <input type="date" id="dataNasc" class="perfil-input" required>

            <label class="perfil-label">Email</label>
            <input type="email" id="email" class="perfil-input" required>

            <div class="perfil-actions">
                <button type="submit" class="perfil-btn salvar">Salvar Alterações</button>
                <button type="button" class="perfil-btn cancelar"
                    onclick="window.location.href='home.html'">Cancelar</button>
            </div>
        </form>
    </div>

    <script>

let senhaExistente = '';

window.onload = async function () {
  const autenticado = localStorage.getItem('authenticated');
  const userId = localStorage.getItem('userId');

  if (!autenticado || !userId) {
    window.location.href = "login.html";
    return;
  }

  try {
    const resp = await fetch(`https://localhost:7092/Usuario/${userId}`);
    if (resp.ok) {
      const user = await resp.json();

      document.getElementById("nome").value = user.nome || "";
      document.getElementById("cpf").value = user.cpf || "";

      if (user.data_Nasc) {
        const data = new Date(user.data_Nasc);
        document.getElementById("dataNasc").value = data.toISOString().split("T")[0];
      }

      document.getElementById("email").value = user.email || "";

      senhaExistente = user.senha ?? user.Senha ?? '';
    }
  } catch (err) {
    console.error("Erro ao carregar usuário:", err);
  }
};

document.getElementById("perfilForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const userId = localStorage.getItem('userId');

  const usuario = {
    nome: document.getElementById("nome").value,
    cpf: document.getElementById("cpf").value,
    data_Nasc: document.getElementById("dataNasc").value,
    email: document.getElementById("email").value,
    senha: senhaExistente // <-- reenviando a senha original para o PUT
  };

  try {
    const resp = await fetch(`https://localhost:7092/Usuario/${userId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(usuario)
    });

    if (resp.ok) {
      alert("Perfil atualizado com sucesso!");
    } else {
      const texto = await resp.text();
      console.error("PUT inválido:", resp.status, texto);
      alert("Erro ao atualizar perfil");
    }
  } catch (err) {
    console.error("Erro:", err);
    alert("Falha na conexão com o servidor");
  }
});

</script>
<script src="app.js"></script>
</body>

</html>
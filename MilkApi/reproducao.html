<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Gestão de Reprodução</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" />
</head>

<body>
  <nav>
    <div class="nav1">
      <div class="logo">Cownt</div>
      <div class="menu">
        <a href="dashboard.html"><i class="ph-bold ph-house-line"></i> Dashboard</a>
        <a href="estatisticas.html"><i class="ph-bold ph-chart-line"></i> Estatísticas</a>
        <a href="addgado.html"><i class="ph ph-cow"></i> Gerenciar Gados</a>
        <a href="ocorrenciadiaria.html" class="active"><i class="ph-bold ph-calendar-dots"></i> Ocorrências
          Diárias</a>
      </div>
      <div class="logout">
        <a href="#"><i class="ph-bold ph-sign-out"></i> Sair</a>
      </div>
    </div>
  </nav>

  <div class="body-margin">
    <div class="card-container">
      <h1>Gestão de Reprodução</h1>
      <div class="btn-add" onclick="abrirModal('reproducao')">
        <i class="fa-solid fa-plus"></i> Nova Reprodução
      </div>
    </div>

    <div class="listaCards"></div>

    <!-- Modal de Reprodução -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModal()">&times;</span>
        <h2 id="modal-titulo"></h2>
        <form id="modal-form">
          <input type="hidden" id="reproducaoId">
          <label>Brinco do Gado:</label>
          <input type="number" id="brinco" required>
          <div id="campos-especificos"></div>
          <button type="submit">Salvar</button>
        </form>
      </div>
    </div>

    <!-- Modal de Prenhez -->
    <div id="modalPrenhez" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModalPrenhez()">&times;</span>
        <h2>Registrar Prenhez</h2>
        <form id="form-prenhez">
          <input type="hidden" id="prenhez-gado-id">
          <label>Data da Prenhez:</label>
          <input type="date" id="prenhez-data" required>
          <button type="submit">Salvar</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const apiBase = "https://localhost:7092";
    let tipoAtual = "";

    function abrirModal(tipo, dados = null) {
      tipoAtual = tipo;
      document.getElementById("modal").style.display = "block";
      document.getElementById("modal-titulo").innerText = dados ? "Editar Reprodução" : "Nova Reprodução";

      const hoje = new Date().toISOString().split("T")[0];
      let camposHTML = `
        <label>Data:</label>
        <input type="date" id="data" value="${dados ? dados.data.split("T")[0] : hoje}" required>
        <label>Tipo:</label>
        <input type="text" id="tipo" value="${dados ? dados.tipo : ""}" placeholder="Ex.: Monta, Inseminação..." required>
        <label>Observação:</label>
        <textarea id="observacao" rows="3" placeholder="Observações adicionais">${dados ? dados.observacao : ""}</textarea>
      `;
      document.getElementById("campos-especificos").innerHTML = camposHTML;

      document.getElementById("brinco").value = dados && dados.gado ? dados.gado.brinco : "";
      document.getElementById("reproducaoId").value = dados ? dados.id : "";
    }

    function fecharModal() {
      document.getElementById("modal").style.display = "none";
      document.getElementById("modal-form").reset();
    }

    function abrirModalPrenhez(gadoId) {
      document.getElementById("prenhez-gado-id").value = gadoId;
      document.getElementById("modalPrenhez").style.display = "block";
    }

    function fecharModalPrenhez() {
      document.getElementById("modalPrenhez").style.display = "none";
    }

    function addDays(date, days) {
      const result = new Date(date.getTime());
      result.setDate(result.getDate() + days);
      return result;
    }

    async function carregarReproducao() {
      const usuarioId = localStorage.getItem("userId");
      if (!usuarioId) return;

      const lista = document.querySelector(".listaCards");
      lista.innerHTML = "<p>Carregando...</p>";

      try {
        const resp = await fetch(`${apiBase}/reproducao/por-usuario?usuarioId=${usuarioId}`);
        if (!resp.ok) throw new Error("Erro ao buscar reproduções");
        const dados = await resp.json();
        lista.innerHTML = "";
        if (dados.length === 0) {
          lista.innerHTML = "<p>Nenhum registro encontrado.</p>";
          return;
        }

        for (const r of dados) {
          const div = document.createElement("div");
          div.className = "card";

          let gado = {};
          try {
            const resGado = await fetch(`${apiBase}/gado/${r.iD_Gado}`);
            if (resGado.ok) gado = await resGado.json();
          } catch { }

          div.innerHTML = `
            <p><strong>Brinco:</strong> ${gado.brinco || 'N/A'}</p>
            <p><strong>Data:</strong> ${new Date(r.data).toLocaleDateString("pt-BR")}</p>
            <p><strong>Tipo:</strong> ${r.tipo}</p>
            <p><strong>Obs:</strong> ${r.observacao || '-'}</p>
            ${r.data_Esperada ? `<p><strong>Data Esperada:</strong> ${new Date(r.data_Esperada).toLocaleDateString("pt-BR")}</p>` : ""}
            <div class="card-actions">
              <button class="btn-edit" onclick='abrirModal("reproducao", ${JSON.stringify({ ...r, gado })})'>
                <i class="fa-solid fa-pen-to-square"></i> Editar
              </button>
              <button class="btn-delete" onclick="excluirReproducao(${r.id})">
                <i class="fa-solid fa-trash"></i>
              </button>
              <button class="btn-prenha" onclick="abrirModalPrenhez(${gado.id})">
                <i class="fa-solid fa-venus"></i> Marcar Prenha
              </button>
            </div>
          `;
          lista.appendChild(div);
        }
      } catch (err) {
        lista.innerHTML = "<p>Erro ao carregar registros.</p>";
        console.error(err);
      }
    }

    async function excluirReproducao(id) {
      if (!confirm("Deseja excluir este registro de reprodução?")) return;
      try {
        const res = await fetch(`${apiBase}/reproducao/${id}`, { method: "DELETE" });
        if (res.ok) {
          alert("Registro excluído com sucesso!");
          carregarReproducao();
        } else {
          alert("Erro ao excluir registro.");
        }
      } catch (err) {
        alert("Erro de conexão: " + err.message);
      }
    }

    document.getElementById("modal-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const reproducaoId = document.getElementById("reproducaoId").value;
      const brinco = document.getElementById("brinco").value;
      const usuarioId = localStorage.getItem("userId");

      try {
        const resGado = await fetch(`${apiBase}/gado/por-brinco?brinco=${brinco}&usuarioId=${usuarioId}`);
        if (!resGado.ok) { alert("Gado não encontrado"); return; }
        const gado = await resGado.json();

        const payload = {
          ID_Gado: gado.id,
          Data: document.getElementById("data").value,
          Tipo: document.getElementById("tipo").value,
          Observacao: document.getElementById("observacao").value,
          ID_Usuario: usuarioId
        };

        const url = reproducaoId ? `${apiBase}/reproducao/${reproducaoId}` : `${apiBase}/reproducao`;
        const method = reproducaoId ? "PUT" : "POST";

        const saveRes = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (saveRes.ok) {
          alert("Registro salvo com sucesso!");
          fecharModal();
          carregarReproducao();
        } else {
          const err = await saveRes.text();
          alert("Erro ao salvar: " + err);
        }
      } catch (err) {
        alert("Erro de conexão: " + err.message);
        console.error(err);
      }
    });

    document.getElementById("form-prenhez").addEventListener("submit", async function (e) {
      e.preventDefault();
      const usuarioId = localStorage.getItem("userId");
      const gadoId = document.getElementById("prenhez-gado-id").value;
      const dataPrenhezInput = document.getElementById("prenhez-data").value;
      if (!usuarioId || !gadoId || !dataPrenhezInput) { alert("Dados inválidos."); return; }

      const dataPrenhez = new Date(dataPrenhezInput);
      const dataEsperada = addDays(dataPrenhez, 283);

      const payload = {
        ID_Gado: parseInt(gadoId),
        Data_Prenhez: dataPrenhezInput,
        Data_Esperada: dataEsperada.toISOString().split("T")[0],
        ID_Usuario: usuarioId,
        Status: "Prenha"
      };

      try {
        const res = await fetch(`${apiBase}/prenhez`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          alert("Prenhez registrada com sucesso!");
          fecharModalPrenhez();
        } else {
          const err = await res.text();
          alert("Erro ao registrar prenhez: " + err);
        }
      } catch (err) {
        alert("Erro de conexão: " + err.message);
        console.error(err);
      }
    });

    carregarReproducao();
  </script>
</body>
</html>

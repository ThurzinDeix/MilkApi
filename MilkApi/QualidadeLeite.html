<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Lotes de Leite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        .card, .lote-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            width: 250px;
            text-align: center;
            box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

            .card:hover, .lote-card:hover {
                transform: scale(1.05);
            }

        .hidden {
            display: none;
        }

        .leite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0px 1px 4px rgba(0,0,0,0.1);
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }

            button:hover {
                background: #45a049;
            }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 20px;
            width: 300px;
            border-radius: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Gestão de Lotes de Leite</h1>

    <div id="telaInicial">
        <div class="card" onclick="abrirSelecaoLeite()">Criar Lote</div>
        <h2>Lotes Criados</h2>
        <div id="listaLotes"></div>
    </div>

    <div id="telaLeite" class="hidden">
        <h2>Selecione os Leites</h2>
        <div id="listaLeites"></div>
        <button onclick="concluirLote()">Concluir Lote</button>
        <button onclick="voltarInicio()">Voltar</button>
    </div>

    <div id="modalQualidade" class="modal">
        <div class="modal-content">
            <h3>Adicionar Qualidade</h3>
            <label>CCS: <input type="number" id="inputCCS"></label><br><br>
            <label>Gordura: <input type="number" step="0.01" id="inputGordura"></label><br><br>
            <label>Proteína: <input type="number" step="0.01" id="inputProteina"></label><br><br>
            <button onclick="salvarQualidade()">Salvar</button>
            <button onclick="fecharModal()">Cancelar</button>
        </div>
    </div>

    <script>
        const apiBase = "https://localhost:7092/";
        const idusuario = localStorage.getItem("userId");
        let leites = [];
        let lotes = [];
        let loteSelecionado = [];
        let loteAtualQualidade = null;

        function abrirSelecaoLeite() {
            document.getElementById("telaInicial").classList.add("hidden");
            document.getElementById("telaLeite").classList.remove("hidden");
            carregarLeites();
        }

        async function carregarLeites() {
            try {
                const res = await fetch(`${apiBase}leite`);
                leites = await res.json();
                renderLeites();
            } catch (err) {
                alert("Erro ao carregar leites: " + err);
            }
        }

        function renderLeites() {
            const container = document.getElementById("listaLeites");
            container.innerHTML = "";
            leites.forEach(leite => {
                const div = document.createElement("div");
                div.classList.add("leite-item");
                div.innerHTML = `
                        <div>
                            <strong>Brinco:</strong> ${leite.iD_Gado} <br>
                            <strong>Data:</strong> ${new Date(leite.data).toLocaleDateString()} <br>
                            <strong>Litros:</strong> ${leite.litros}
                        </div>
                        <button onclick="adicionarLeite(${leite.Id})">Adicionar</button>
                    `;
                container.appendChild(div);
            });
        }

        function adicionarLeite(id) {
            const leite = leites.find(l => l.Id === id);
            if (!loteSelecionado.includes(leite)) {
                loteSelecionado.push(leite);
                alert("Leite adicionado ao lote!");
            }
        }

        async function concluirLote() {
            if (loteSelecionado.length === 0) {
                alert("Selecione pelo menos um leite!");
                return;
            }
            try {
                // Pegar os IDs corretamente (note que no seu objeto é 'Id', com I maiúsculo)
                const idsLeite = loteSelecionado.map(l => l.Id);

                const res = await fetch(`${apiBase}lote/criar-com-leites`, { // <--- endpoint correto
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        Num: lotes.length + 1,
                        ID_Usuario: 1,
                        IDsLeite: idsLeite // <--- precisa bater com o DTO
                    })
                });

                if (res.ok) {
                    let novoLote = null;
                    const text = await res.text();
                    if (text) {
                        novoLote = JSON.parse(text);
                    }
                    loteSelecionado = [];
                    voltarInicio();
                    carregarLotes();
                } else {
                    const erro = await res.json();
                    alert("Erro ao criar lote: " + JSON.stringify(erro));
                }
            } catch (err) {
                alert("Erro ao criar lote: " + err);
            }
        }


        function voltarInicio() {
            document.getElementById("telaLeite").classList.add("hidden");
            document.getElementById("telaInicial").classList.remove("hidden");
        }

        async function carregarLotes() {
            try {
                const res = await fetch(`${apiBase}lote`);
                lotes = await res.json();
                renderLotes();
            } catch (err) {
                alert("Erro ao carregar lotes: " + err);
            }
        }

        function renderLotes() {
            const container = document.getElementById("listaLotes");
            container.innerHTML = "";
            lotes.forEach(lote => {
                const totalLitros = lote.Leites.reduce((sum, l) => sum + l.Litros, 0);
                const div = document.createElement("div");
                div.classList.add("lote-card");
                div.innerHTML = `
                        <strong>Lote #${lote.Id}</strong><br>
                        Quantidade de Leites: ${lote.Leites.length} <br>
                        Total Litros: ${totalLitros.toFixed(2)} <br>
                        Qualidade: ${lote.Qualidade ? 'Definida' : 'Não definida'} <br>
                        <button onclick="abrirModalQualidade(${lote.Id})">Adicionar Qualidade</button>
                    `;
                container.appendChild(div);
            });
        }

        function abrirModalQualidade(loteId) {
            loteAtualQualidade = loteId;
            document.getElementById("modalQualidade").style.display = "block";
        }

        function fecharModal() {
            document.getElementById("modalQualidade").style.display = "none";
            loteAtualQualidade = null;
        }

        async function salvarQualidade() {
            const ccs = parseInt(document.getElementById("inputCCS").value);
            const gordura = parseFloat(document.getElementById("inputGordura").value);
            const proteina = parseFloat(document.getElementById("inputProteina").value);
            try {
                await fetch(`${apiBase}qualidade`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        ID_Lote: loteAtualQualidade,
                        CCS: ccs,
                        Gordura: gordura,
                        Proteina: proteina
                    })
                });
                fecharModal();
                carregarLotes();
            } catch (err) {
                alert("Erro ao salvar qualidade: " + err);
            }
        }

        // Carrega lotes ao iniciar
        carregarLotes();
    </script>
</body>
</html>

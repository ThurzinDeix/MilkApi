<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Lotes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"
    />

</head>

<body>
    <nav>
        <div class="nav1">
            <div class="logo">Cownt</div>
            <div class="menu">
                <a href="dashboard.html"><i class="ph-bold ph-house-line"></i> Dashboard</a>
                <a href="estatisticas.html"><i class="ph-bold ph-chart-line"></i> Estatísticas</a>
                <a href="addgado.html"><i class="ph ph-cow"></i> Gerenciar Gados</a>
                <a href="ocorrenciadiaria.html" class="active"><i class="ph-bold ph-calendar-dots"></i> Ocorrências
                    Diárias</a>
            </div>
            <div class="logout">
                <a href="#"><i class="ph-bold ph-sign-out"></i> Sair</a>
            </div>
        </div>
    </nav>

    <h2>Lotes</h2>
    <div>
        <button id="novoLoteBtn">Novo Lote</button>
    </div>
    <div id="lotes" class="cards"></div>

    

    <!-- Modal Leite -->
<div id="leiteModal" class="modal-leite">
    <div class="modal-content-leite">
        <span class="close-leite" onclick="document.getElementById('modalLeite').style.display='none'">&times;</span>
        
        <h2>Criar Novo Lote</h2>
        <p>Selecione os registros de leite e defina a qualidade do lote.</p>

        <label for="numLoteInput-leite">Nº do Lote: </label>
        <input class="input-lote" type="number" id="numLoteInput" placeholder="Digite o número do lote">


        <hr>

        <p>Selecione os registros de leite para o lote:</p>

        <div id="leites" class="cards-leite"></div>

        <button id="criarLoteBtn-leite">Criar Lote</button>
    </div>
</div>


    <!-- Modal de Qualidade -->
    <div id="qualidadeModal" class="modal">
        <div class="modal-content-leite">
            <h3>Adicionar Qualidade</h3>
            <input type="number" id="ccsInput" placeholder="CCS">
            <input type="number" id="proteinaInput" placeholder="Proteína">
            <input type="number" id="gorduraInput" placeholder="Gordura">
            <button id="salvarQualidadeBtn">Salvar</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://localhost:7092'; // Substitua pela URL da sua API
    
        const lotesContainer = document.getElementById("lotes");
        const leitesContainer = document.getElementById("leites");
        const novoLoteBtn = document.getElementById("novoLoteBtn");
        const criarLoteBtn = document.getElementById("criarLoteBtn-leite"); // corrigido
        const qualidadeModal = document.getElementById("qualidadeModal");
        const salvarQualidadeBtn = document.getElementById("salvarQualidadeBtn");
        const ccsInput = document.getElementById("ccsInput");
        const proteinaInput = document.getElementById("proteinaInput");
        const gorduraInput = document.getElementById("gorduraInput");
        const numLoteInput = document.getElementById("numLoteInput");
        const leiteModal = document.getElementById("leiteModal"); // corrigido
    
        let leites = [];
        let lotes = [];
        let selecionados = [];
        let loteSelecionadoParaQualidade = null;
    
        // Buscar lotes
        async function buscarLotes() {
            try {
                const res = await fetch(`${API_BASE}/lote`);
                if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);
                lotes = await res.json();
                renderLotes();
            } catch (err) {
                console.error("Erro ao buscar lotes:", err);
                alert(`Erro ao buscar lotes: ${err.message}`);
            }
        }
    
        // Buscar leites
        async function buscarLeites() {
            try {
                const res = await fetch(`${API_BASE}/leite`);
                if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);
                leites = await res.json();
                renderLeites();
            } catch (err) {
                console.error("Erro ao buscar leites:", err);
                alert(`Erro ao buscar leites: ${err.message}`);
            }
        }
    
        // Criar lote com leites
        async function criarLoteAPI(leitesSelecionados, numLote) {
            const userId = localStorage.getItem("userId");
            const body = {
                Num: numLote,
                ID_Usuario: userId,
                IDsLeite: leitesSelecionados.map(l => l.id)
            };
            try {
                const res = await fetch(`${API_BASE}/lote/criar-com-leites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
    
                if (!res.ok) {
                    const text = await res.text();
                    console.error("Erro ao criar lote:", text);
                    alert(`Erro ao criar lote!\nStatus: ${res.status}\nMensagem: ${text}`);
                    return;
                }
    
                const data = await res.json();
                console.log("Lote criado:", data);
                alert(`Lote criado com sucesso! ID: ${data.loteId}`);
            } catch (err) {
                console.error("Erro ao criar lote:", err);
                alert(`Erro ao criar lote: ${err.message}`);
            }
        }
    
        // Render lotes
        function renderLotes() {
            lotesContainer.innerHTML = '';
            lotes.forEach(lote => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<strong>Lote ${lote.num}</strong>
                              <p>Leites: ${lote.leites?.map(l => l.id).join(", ") || ''}</p>
                              ${lote.qualidade ? `<p>CCS: ${lote.qualidade.ccs}, Prot: ${lote.qualidade.proteina}, Gord: ${lote.qualidade.gordura}</p>` : ''}
                              <button onclick="abrirModalQualidade(${lote.id})">Adicionar Qualidade</button>`;
                lotesContainer.appendChild(card);
            });
        }
    
        // Render leites
        function renderLeites() {
            leitesContainer.innerHTML = '';
            leites.forEach(leite => {
                const card = document.createElement('div');
                card.className = 'card-leite';
                const jaSelecionado = lotes.some(l => l.leites?.some(ll => ll.id === leite.id));
                if (selecionados.includes(leite.id) || jaSelecionado) card.classList.add('opaco-leite');
                card.innerHTML = `<strong>Leite ID: ${leite.id}</strong>
                              <p class="brinco">ID Gado: ${leite.iD_Gado}</p>
                              <p>Litros: ${leite.litros}</p>
                              <p>Data: ${leite.data}`;
                card.addEventListener('click', () => {
                    if (!selecionados.includes(leite.id)) {
                        selecionados.push(leite.id);
                        card.classList.add('opaco-leite');
                    } else {
                        selecionados = selecionados.filter(id => id !== leite.id);
                        if (!jaSelecionado) card.classList.remove('opaco-leite');
                    }
                });
                leitesContainer.appendChild(card);
            });
        }
    
        function abrirModalQualidade(loteId) {
            loteSelecionadoParaQualidade = loteId;
            const lote = lotes.find(l => l.id === loteId);
    
            if (lote && lote.qualidade) {
                ccsInput.value = lote.qualidade.ccs;
                proteinaInput.value = lote.qualidade.proteina;
                gorduraInput.value = lote.qualidade.gordura;
            } else {
                ccsInput.value = '';
                proteinaInput.value = '';
                gorduraInput.value = '';
            }
            qualidadeModal.style.display = 'flex';
        }
    
        // Eventos
        novoLoteBtn.addEventListener('click', async () => {
            leiteModal.style.display = 'flex';
            selecionados = [];
            numLoteInput.value = '';
            await buscarLeites();
        });
    
        criarLoteBtn.addEventListener('click', async () => {
            const numLote = parseInt(numLoteInput.value);
            if (isNaN(numLote) || numLote <= 0) {
                alert("Digite um número de lote válido!");
                return;
            }
    
            if (selecionados.length === 0) {
                alert("Selecione pelo menos um leite!");
                return;
            }
    
            const leitesParaLote = leites.filter(l => selecionados.includes(l.id));
            await criarLoteAPI(leitesParaLote, numLote);
            leiteModal.style.display = 'none';
            selecionados = [];
            numLoteInput.value = '';
            await buscarLotes();
        });
    
        salvarQualidadeBtn.addEventListener('click', async () => {
            const userId = localStorage.getItem("userId");
            if (!loteSelecionadoParaQualidade) {
                alert("Nenhum lote selecionado!");
                return;
            }
    
            let qualidade = {
                ID_Lote: loteSelecionadoParaQualidade,
                CCS: parseInt(ccsInput.value),
                Proteina: parseFloat(proteinaInput.value),
                Gordura: parseFloat(gorduraInput.value),
                ID_Usuario: userId 
            };
    
            let qualidadeExistente = lotes.find(l => l.id === loteSelecionadoParaQualidade)?.qualidade;
    
            let url, metodo;
            if (qualidadeExistente) {
                url = `${API_BASE}/Qualidade/${qualidadeExistente.Id}`;
                metodo = 'PUT';
            } else {
                url = `${API_BASE}/Qualidade`;
                metodo = 'POST';
            }
    
            try {
                const res = await fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(qualidade)
                });
    
                if (!res.ok) {
                    const text = await res.text();
                    alert(`Erro ao salvar qualidade!\nStatus: ${res.status}\nMensagem: ${text}`);
                    console.error("Erro ao salvar qualidade:", text);
                } else {
                    alert("Qualidade salva com sucesso!");
                    qualidadeModal.style.display = 'none';
                    await buscarLotes();
                }
            } catch (err) {
                alert(`Erro ao salvar qualidade: ${err.message}`);
                console.error("Erro ao salvar qualidade:", err);
            }
        });
    
        // Fechar modais clicando fora
        qualidadeModal.addEventListener('click', (e) => {
            if (e.target === qualidadeModal) qualidadeModal.style.display = 'none';
        });
        leiteModal.addEventListener('click', (e) => {
            if (e.target === leiteModal) leiteModal.style.display = 'none';
        });
    
        // Inicial
        buscarLotes();
    </script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Lotes</title>
    <style>
        body {
            font-family: Arial,sans-serif;
            background: #f4f7fa;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #2c3e50;
        }

        button {
            padding: 10px 20px;
            margin: 10px 0;
            background: #3498db;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }

            button:hover {
                background: #2980b9;
            }

        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 200px;
            position: relative;
        }

            .card.opaco {
                opacity: 0.5;
            }

            .card button {
                margin-top: 10px;
                width: 100%;
            }

        #leiteSelection {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }

            .modal-content input {
                width: 100%;
                padding: 8px;
                margin: 5px 0 15px 0;
            }

            .modal-content button {
                width: 100%;
            }
    </style>
</head>
<body>

    <h2>Lotes</h2>
    <div>
        <button id="novoLoteBtn">Novo Lote</button>
    </div>
    <div id="lotes" class="cards"></div>

    <div id="leiteSelection">
        <h2>Selecione os Leites</h2>
        <input type="number" id="numLoteInput" placeholder="Número do Lote" style="width:100%; padding:8px; margin-bottom:10px;">
        <div id="leites" class="cards"></div>
        <button id="criarLoteBtn">Criar Lote</button>
    </div>

    <div id="qualidadeModal" class="modal">
        <div class="modal-content">
            <h3>Adicionar Qualidade</h3>
            <input type="number" id="ccsInput" placeholder="CCS">
            <input type="number" id="proteinaInput" placeholder="Proteína">
            <input type="number" id="gorduraInput" placeholder="Gordura">
            <button id="salvarQualidadeBtn">Salvar</button>
        </div>
    </div>

    <script>
    const API_BASE = 'https://localhost:7092'; // Substitua pela URL da sua API

    const lotesContainer = document.getElementById("lotes");
    const leitesContainer = document.getElementById("leites");
    const leiteSelection = document.getElementById("leiteSelection");
    const novoLoteBtn = document.getElementById("novoLoteBtn");
    const criarLoteBtn = document.getElementById("criarLoteBtn");
    const qualidadeModal = document.getElementById("qualidadeModal");
    const salvarQualidadeBtn = document.getElementById("salvarQualidadeBtn");
    const ccsInput = document.getElementById("ccsInput");
    const proteinaInput = document.getElementById("proteinaInput");
    const gorduraInput = document.getElementById("gorduraInput");
    const numLoteInput = document.getElementById("numLoteInput");



    let leites = [];
    let lotes = [];
    let selecionados = [];
    let loteSelecionadoParaQualidade = null;

    // Buscar lotes
    async function buscarLotes() {
        try {
            const res = await fetch(`${API_BASE}/lote`);
            if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);
            lotes = await res.json();
            renderLotes();
        } catch (err) {
            console.error("Erro ao buscar lotes:", err);
            alert(`Erro ao buscar lotes: ${err.message}`);
        }
    }

    // Buscar leites
    async function buscarLeites() {
        try {
            const res = await fetch(`${API_BASE}/leite`);
            if (!res.ok) throw new Error(`Erro ${res.status}: ${res.statusText}`);
            leites = await res.json();
            renderLeites();
        } catch (err) {
            console.error("Erro ao buscar leites:", err);
            alert(`Erro ao buscar leites: ${err.message}`);
        }
    }

    // Criar lote com leites
    async function criarLoteAPI(leitesSelecionados, numLote) {
        const userId = localStorage.getItem("userId");
        const body = {
            Num: numLote,
            ID_Usuario: userId,
            IDsLeite: leitesSelecionados.map(l => l.id) // aqui fica exatamente como você já tinha
        };
        try {
            const res = await fetch(`${API_BASE}/lote/criar-com-leites`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const text = await res.text();
                console.error("Erro ao criar lote:", text);
                alert(`Erro ao criar lote!\nStatus: ${res.status}\nMensagem: ${text}`);
                return;
            }

            const data = await res.json();
            console.log("Lote criado:", data);
            alert(`Lote criado com sucesso! ID: ${data.loteId}`);
        } catch (err) {
            console.error("Erro ao criar lote:", err);
            alert(`Erro ao criar lote: ${err.message}`);
        }
    }

    // Salvar qualidade
    async function salvarQualidadeAPI(loteId, qualidade) {
        try {
            const res = await fetch(`${API_BASE}/lote/${loteId}/qualidade`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(qualidade)
            });
            if (!res.ok) {
                const text = await res.text();
                console.error("Erro ao salvar qualidade:", text);
                alert(`Erro ao salvar qualidade!\nStatus: ${res.status}\nMensagem: ${text}`);
            } else {
                alert("Qualidade salva com sucesso!");
            }
        } catch (err) {
            console.error("Erro ao salvar qualidade:", err);
            alert(`Erro ao salvar qualidade: ${err.message}`);
        }
    }

    // Render lotes
    function renderLotes() {
        lotesContainer.innerHTML = '';
        lotes.forEach(lote => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<strong>Lote ${lote.num}</strong>
                              <p>Leites: ${lote.leites?.map(l => l.id).join(", ") || ''}</p>
                              ${lote.qualidade ? `<p>CCS: ${lote.qualidade.ccs}, Prot: ${lote.qualidade.proteina}, Gord: ${lote.qualidade.gordura}</p>` : ''}
                              <button onclick="abrirModalQualidade(${lote.id})">Adicionar Qualidade</button>`; 
            lotesContainer.appendChild(card);
        });
    }

    // Render leites
    function renderLeites() {
        leitesContainer.innerHTML = '';
        leites.forEach(leite => {
            const card = document.createElement('div');
            card.className = 'card';
            const jaSelecionado = lotes.some(l => l.leites?.some(ll => ll.id === leite.id));
            if (selecionados.includes(leite.id) || jaSelecionado) card.classList.add('opaco');
            card.innerHTML = `<strong>Leite ID: ${leite.id}</strong>
                              <p>Gado ID: ${leite.iD_Gado}</p>
                              <p>Litros: ${leite.litros}</p>`;
            card.addEventListener('click', () => {
                if (!selecionados.includes(leite.id)) {
                    selecionados.push(leite.id);
                    card.classList.add('opaco');
                } else {
                    selecionados = selecionados.filter(id => id !== leite.id);
                    if (!jaSelecionado) card.classList.remove('opaco');
                }
            });
            leitesContainer.appendChild(card);
        });
    }

        function abrirModalQualidade(loteId) {
            alert("abrirModalQualidade chamado com loteId: " + loteId);

            loteSelecionadoParaQualidade = loteId;
            alert("loteSelecionadoParaQualidade agora é: " + loteSelecionadoParaQualidade);

            const lote = lotes.find(l => l.id === loteId);
            if (lote) {
                alert("Lote encontrado: " + JSON.stringify(lote));
            } else {
                alert("Nenhum lote encontrado para esse ID!");
            }

            if (lote && lote.qualidade) {
                ccsInput.value = lote.qualidade.ccs;
                proteinaInput.value = lote.qualidade.proteina;
                gorduraInput.value = lote.qualidade.gordura;
            } else {
                ccsInput.value = '';
                proteinaInput.value = '';
                gorduraInput.value = '';
            }
            qualidadeModal.style.display = 'flex';
        }

    // Eventos
    novoLoteBtn.addEventListener('click', async () => {
        leiteSelection.style.display = 'block';
        selecionados = [];
        numLoteInput.value = '';
        await buscarLeites();
    });

    criarLoteBtn.addEventListener('click', async () => {
        const numLote = parseInt(numLoteInput.value);
        if (isNaN(numLote) || numLote <= 0) {
            alert("Digite um número de lote válido!");
            return;
        }

        if (selecionados.length === 0) {
            alert("Selecione pelo menos um leite!");
            return;
        }

        const leitesParaLote = leites.filter(l => selecionados.includes(l.id));
        await criarLoteAPI(leitesParaLote, numLote);
        leiteSelection.style.display = 'none';
        selecionados = [];
        numLoteInput.value = '';
        await buscarLotes();
    });



        salvarQualidadeBtn.addEventListener('click', async () => {
            if (!loteSelecionadoParaQualidade) {
                alert("Nenhum lote selecionado!");
                return;
            }

            // Cria o objeto qualidade
            let qualidade = {
                ID_Lote: loteSelecionadoParaQualidade,
                CCS: parseInt(ccsInput.value),
                Proteina: parseFloat(proteinaInput.value),
                Gordura: parseFloat(gorduraInput.value)
            };

            // Verifica se já existe qualidade no lote
            let qualidadeExistente = lotes.find(l => l.id === loteSelecionadoParaQualidade)?.qualidade;

            let url, metodo;
            if (qualidadeExistente) {
                // Atualizar
                url = `${API_BASE}/Qualidade/${qualidadeExistente.Id}`;
                metodo = 'PUT';
            } else {
                // Criar
                url = `${API_BASE}/Qualidade`;
                metodo = 'POST';
            }

            try {
                const res = await fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(qualidade)
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert(`Erro ao salvar qualidade!\nStatus: ${res.status}\nMensagem: ${text}`);
                    console.error("Erro ao salvar qualidade:", text);
                } else {
                    alert("Qualidade salva com sucesso!");
                    qualidadeModal.style.display = 'none';
                    await buscarLotes();
                }
            } catch (err) {
                alert(`Erro ao salvar qualidade: ${err.message}`);
                console.error("Erro ao salvar qualidade:", err);
            }
        });


    qualidadeModal.addEventListener('click', (e) => {
        if (e.target === qualidadeModal) qualidadeModal.style.display = 'none';
    });

    // Inicial
    buscarLotes();
</script>


</body>
</html>

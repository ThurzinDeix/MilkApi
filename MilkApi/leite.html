<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Gestão de Ordenha</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" />
</head>

<body>
    <nav>
        <div class="nav1">
          <div class="logo">Cownt</div>
          <div class="menu">
            <a href="dashboard.html" ><i class="ph-bold ph-house-line"></i> Dashboard</a>
            <a href="estatisticas.html"><i class="ph-bold ph-chart-line"></i> Estatísticas</a>
            <a href="addgado.html"><i class="ph ph-cow"></i> Gerenciar Gados</a>
            <a href="ocorrenciadiaria.html" class="active"><i class="ph-bold ph-calendar-dots"></i> Ocorrências Diárias</a>
            <div class="user-menu">
              <div class="user-avatar" onclick="toggleDropdown()"><i class="ph ph-user-circle"></i></div>
              <div class="dropdown" id="dropdownMenu">
                <a class="drop-menu" href="perfil.html"><i class="ph-bold ph-user"></i> Editar Perfil</a>
                <a class="drop-menu" href="#" onclick="logout()"><i class="ph-bold ph-sign-out"></i> Sair da Conta</a>
              </div>
            </div>
          </div>
          
        </div>
    </nav>
    <content>
        <div class="card-container">
            <h1>Gestão de Ordenha</h1>
            <div class="btn-add" onclick="abrirModal('leite')"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus">
                    <path d="M5 12h14" />
                    <path d="M12 5v14" />
                </svg>Adicionar Ordenha</div>
        </div>

        <div class="listaCards"></div>

        <!-- Modal -->
        <div id="modal" class="modal">
            <div class="modal-content form-modal">
                <span class="close" onclick="fecharModal()">&times;</span>
                <h2 id="modal-titulo"></h2>
                <p class="subtitle">Preencha as informações da ordenha para registrar.</p>

                <form id="modal-form">
                    <label for="brinco">Brinco do Gado</label>
                    <input type="number" id="brinco" placeholder="Ex: 123" required>

                    <div id="campos-especificos"></div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancelar" onclick="fecharModal()">Cancelar</button>
                        <button type="submit" class="btn-adicionar">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

    </content>

    <script>
const apiBase = "https://localhost:7092";
let tipoAtual = "";
let editId = null; // Id do registro sendo editado

function abrirModal(tipo, dados = null) {
    tipoAtual = tipo;
    document.getElementById("modal").style.display = "block";
    document.getElementById("modal-titulo").innerText = dados ? "Editar " + tipo.charAt(0).toUpperCase() + tipo.slice(1) : "Registro de " + tipo.charAt(0).toUpperCase() + tipo.slice(1);

    const hoje = new Date().toISOString().split("T")[0];
    let camposHTML = "";

    if (tipo === "leite") {
        camposHTML = `
            <label>Data:</label>
            <input type="date" id="data" value="${dados ? dados.data.split('T')[0] : hoje}" required>
            <label>Litros:</label>
            <input type="number" id="litros" step="0.01" value="${dados ? dados.litros : ''}" required>
        `;
    }

    document.getElementById("campos-especificos").innerHTML = camposHTML;
    editId = dados ? dados.id : null; // se houver dados, é edição
}

function fecharModal() {
    document.getElementById("modal").style.display = "none";
    editId = null;
}

// Carregar registros de leite
async function carregarLeite() {
    const usuarioId = localStorage.getItem("userId");
    if (!usuarioId) return;

    const lista = document.getElementsByClassName("listaCards")[0];
    lista.innerHTML = "<p>Carregando...</p>";

    try {
        const resp = await fetch(`${apiBase}/leite/por-usuario?usuarioId=${usuarioId}`);
        if (!resp.ok) throw new Error("Erro ao buscar leite");
        const dados = await resp.json();

        lista.innerHTML = "";
        if (dados.length === 0) {
            lista.innerHTML = "<p>Nenhum registro encontrado.</p>";
            return;
        }

        dados.forEach(async l => {
            const div = document.createElement("div");
            div.className = "card";

            try {
                const resGado = await fetch(`${apiBase}/gado/${l.iD_Gado}`);
                let gado = {};
                if (resGado.ok) gado = await resGado.json();

                div.innerHTML = `
                    <p class="brinco"><strong>Brinco:</strong> ${gado.brinco || 'N/A'}</p>
                    <p class="data"><strong>Data:</strong> ${new Date(l.data).toLocaleDateString("pt-BR")}</p>
                    <p><strong>Produção:</strong><br><span class="litros">${l.litros}L</span></p>
                    <div class="card-actions">
                        <button class="btn-edit" onclick='abrirModal("leite", ${JSON.stringify(l)})'>
                            <i class="fa-solid fa-pen-to-square"></i> Editar
                        </button>
                        <button class="btn-delete" onclick="excluirLeite(${l.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash2-icon lucide-trash-2"><path d="M10 11v6"/><path d="M14 11v6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                `;
            } catch (err) {
                div.innerHTML = `<p><strong>Data:</strong> ${new Date(l.data).toLocaleDateString("pt-BR")}</p>
                                 <p><strong>Produção:</strong> ${l.litros}L</p>
                                 <em>Erro ao carregar dados do gado</em>`;
                console.error(err);
            }

            lista.appendChild(div);
        });

    } catch (err) {
        lista.innerHTML = "<p>Erro ao carregar registros.</p>";
        console.error(err);
    }
}

// Excluir registro de leite
async function excluirLeite(id) {
    if (!confirm("Tem certeza que deseja excluir este registro?")) return;

    try {
        const res = await fetch(`${apiBase}/leite/${id}`, { method: "DELETE" });
        if (res.ok) {
            alert("Registro excluído com sucesso!");
            carregarLeite();
        } else {
            alert("Erro ao excluir registro.");
        }
    } catch (err) {
        alert("Erro de conexão: " + err.message);
        console.error(err);
    }
}

// Formulário de salvar (novo ou editar)
document.getElementById("modal-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const brinco = document.getElementById("brinco").value;
    const usuarioId = localStorage.getItem("userId");

    try {
        const resGado = await fetch(`${apiBase}/gado/por-brinco?brinco=${brinco}&usuarioId=${usuarioId}`);
        if (!resGado.ok) { alert("Gado não encontrado"); return; }
        const gado = await resGado.json();

        if (tipoAtual === "leite") {
            const data = document.getElementById("data").value;
            const litros = parseFloat(document.getElementById("litros").value);

            const payload = {
                ID_Gado: gado.id,
                Data: data,
                Litros: litros,
                ID_Usuario: usuarioId
            };

            let url = `${apiBase}/leite`;
            let method = "POST";

            if (editId) { // se for edição
                url = `${apiBase}/leite/${editId}`;
                method = "PUT";
            }

            const saveRes = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (saveRes.ok) {
                alert("Registro salvo com sucesso!");
                fecharModal();
                carregarLeite();
            } else {
                const err = await saveRes.text();
                alert("Erro ao salvar: " + err);
            }
        }

    } catch (err) {
        alert("Erro de conexão: " + err.message);
        console.error(err);
    }
});

carregarLeite();
</script>
<script src="app.js"></script>
</body>

</html>
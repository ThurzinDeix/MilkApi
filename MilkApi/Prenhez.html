<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Vacas Prenhas</title>

    <!-- Seus estilos principais -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <!-- Estilo específico desta página (select + pequenos ajustes) -->

</head>

<body>
    <nav>
        <div class="nav1">
            <div class="logo">Cownt</div>
            <div class="menu">
                <a href="dashboard.html"><i class="ph-bold ph-house-line"></i> Dashboard</a>
                <a href="estatisticas.html"><i class="ph-bold ph-chart-line"></i> Estatísticas</a>
                <a href="addgado.html"><i class="ph ph-cow"></i> Gerenciar Gados</a>
                <a href="ocorrenciadiaria.html" class="active"><i class="ph-bold ph-calendar-dots"></i> Ocorrências
                    Diárias</a>
            </div>
            <div class="logout">
                <a href="#"><i class="ph-bold ph-sign-out"></i> Sair</a>
            </div>
        </div>
    </nav>
    <content>
        <div class="card-container">
            <div class="sla">
                <h1>Vacas Prenhas</h1>
                <p>Gerenciador as vacas em gestação</p>
            </div>

            <div class="filtro-container">
                <label for="filtroStatus" class="filtro-text"><strong>Filtrar:</strong></label>
                <div class="borda">
                    <select id="filtroStatus" class="select-filtro" onchange="carregarVacasPrenhas()">
                        <option value="prenha" selected>Prenha</option>
                        <option value="todas">Todas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Container que usa a sua classe padrão de cards -->
        <div class="listaCards">
            <p>Carregando vacas...</p>
        </div>

        <!-- Modal de Status -->
        <div id="modalStatus" class="modal">
            <div class="modal-content form-modal">
                <span class="close" onclick="fecharModal()">&times;</span>
                <h2>Atualizar Status da Vaca</h2>
                <p class="subtitle">Selecione o novo status da vaca prenha.</p>
                <div class="modal-actions" style="justify-content:center; gap:12px; margin-top:12px;">
                    <button class="btn-adicionar" onclick="atualizarStatus('Pariu')">Pariu</button>
                    <button class="btn-cancelar" style="background:#c0392b; color: #fff;"
                        onclick="atualizarStatus('Aborto')">Aborto</button>
                </div>
            </div>
        </div>

    </content>

    <script>
        const apiBase = "https://localhost:7092";
        let prenhezSelecionada = null;


        async function carregarVacasPrenhas() {
            const usuarioId = localStorage.getItem("userId");
            if (!usuarioId) return;

            const filtro = document.getElementById("filtroStatus").value;
            const container = document.getElementsByClassName("listaCards")[0];
            container.innerHTML = "<p>Carregando vacas...</p>";

            try {
                const resPrenhez = await fetch(`${apiBase}/prenhez/por-usuario?usuarioId=${usuarioId}`);
                if (!resPrenhez.ok) throw new Error("Erro ao buscar prenhez");
                const prenhezList = await resPrenhez.json();

                let vacasFiltradas = prenhezList;
                if (filtro === "prenha") {
                    vacasFiltradas = prenhezList.filter(p => p.status && p.status.toLowerCase() === "prenha");
                }

                if (vacasFiltradas.length === 0) {
                    container.innerHTML = "<p>Nenhuma vaca encontrada.</p>";
                    return;
                }

                container.innerHTML = "";

                for (const p of vacasFiltradas) {
                    const resGado = await fetch(`${apiBase}/gado/${p.iD_Gado}`);
                    let gado = {};
                    if (resGado.ok) gado = await resGado.json();

                    const card = document.createElement("div");
                    card.className = "card gestacao"; // usa .card do seu CSS principal

                    // Determinar classe e texto do badge
                    let statusTexto = p.status || '-';
                    let statusClasse = '';
                    if (statusTexto.toLowerCase() === 'prenha') statusClasse = 'status-prenha';
                    else if (statusTexto.toLowerCase() === 'pariu') statusClasse = 'status-pariu';
                    else if (statusTexto.toLowerCase() === 'aborto') statusClasse = 'status-aborto';

                    // Conteúdo do card
                    card.innerHTML = `
                        <p class="brinco"> <strong>Brinco:</strong> ${gado.brinco || '-'}
                            <span class="badge-status ${statusClasse}">${statusTexto}</span>
                        </p>
                        <p class="descricao"><strong>Raça:</strong> ${gado.raca || '-'}</p>
                        <p class="descricao"><strong>Sexo:</strong> ${gado.sexo || '-'}</p>
                        <p class="descricao"><strong>Peso:</strong> ${gado.peso ? gado.peso + ' kg' : '-'}</p>
                        <p class="descricao"><strong>Data da Prenhez:</strong> ${p.data_Prenhez ? new Date(p.data_Prenhez).toLocaleDateString('pt-BR') : '-'}</p>
                        <p class="descricao"><strong>Data Esperada do Parto:</strong> ${p.data_Esperada ? new Date(p.data_Esperada).toLocaleDateString('pt-BR') : '-'}</p>
                        <p class="descricao"><strong>Observações:</strong> ${p.observacao || '-'}</p>
                        <div class="card-actions" style="margin-top:12px;">
                            <button class="btn-edit" onclick="abrirModal(${p.id})">Atualizar Status</button>
                        </div>
                    `;


                    container.appendChild(card);
                }

            } catch (err) {
                container.innerHTML = `<p>Erro ao carregar vacas: ${err.message}</p>`;
                console.error(err);
            }
        }

        function abrirModal(prenhezId) {
            prenhezSelecionada = prenhezId;
            document.getElementById("modalStatus").style.display = "block";
        }

        function fecharModal() {
            document.getElementById("modalStatus").style.display = "none";
            prenhezSelecionada = null;
        }

        async function atualizarStatus(novoStatus) {
            if (!prenhezSelecionada) return;

            try {
                // Buscar dados atuais da prenhez para enviar no PUT
                const resAtual = await fetch(`${apiBase}/prenhez/${prenhezSelecionada}`);
                if (!resAtual.ok) throw new Error("Erro ao buscar dados da prenhez");
                const prenhez = await resAtual.json();

                // Atualizar apenas o status e manter os outros dados (atenção ao nome da propriedade exigida pela API)
                prenhez.Status = novoStatus;

                const res = await fetch(`${apiBase}/prenhez/${prenhezSelecionada}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(prenhez)
                });

                if (!res.ok) throw new Error("Erro ao atualizar status");

                fecharModal();

                if (novoStatus === "Pariu") {
                    window.location.href = "addgado.html";
                } else {
                    carregarVacasPrenhas();
                }

            } catch (err) {
                alert("Erro ao atualizar status: " + err.message);
                console.error(err);
            }
        }

        window.onload = carregarVacasPrenhas;

        // Fecha modal ao clicar fora (melhoria UX)
        window.onclick = function (event) {
            const modal = document.getElementById("modalStatus");
            if (event.target === modal) fecharModal();
        };
    </script>
</body>

</html>